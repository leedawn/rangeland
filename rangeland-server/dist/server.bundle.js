!function(e){var t={};function o(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(s,n,function(t){return e[t]}.bind(null,n));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=17)}([function(e,t,o){o(10);e.exports={DB_URL:"mongodb://test:123456@47.99.202.255:15001/testdb",REDIS:{host:"47.99.202.255",port:15001,password:"123456"},uploadPath:"/app/public",JWT_SECRET:"onedaythisismyfuture",baseUrl:"none",wsPort:3001}},function(e,t){e.exports=require("dayjs")},function(e,t,o){const s=o(5),n=o(0),i=o(8);t.getJWTPayload=function(e){return console.log("secret->secret",e.split("")[1]),i.verify(e.split(" ")[1],n.JWT_SECRET)},t.checkCode=async function e(t,o){console.log("checkCode -> checkCode",e);const n=await s.getValue(t);return console.log("checkCode -> redisData",n),null!=n&&n.toLowerCase()===o.toLowerCase()}},function(e,t){e.exports=require("koa-router")},function(e,t,o){const s=o(34);s.set("useCreateIndex",!0);const n="mongodb://echo:123456@47.99.202.255:27018/testdb";s.connect(n,{useNewUrlParser:!0,useUnifiedTopology:!0}),s.connection.on("connected",()=>{console.log("Mongoose connection open to "+n)}),s.connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),s.connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")}),e.exports=s},function(e,t,o){const s=o(32);var n={host:"47.99.202.255",port:15001,password:"123456",detect_buffers:!0,retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}};const i=o(33).promisifyAll(s.createClient(n));i.on("error",(function(e){console.log("Redis Client Error:"+e)}));e.exports={client:i,setValue:function(e,t,o){void 0!==t&&null!=t&&""!==t&&("string"==typeof t?void 0!==o?i.set(e,t,"EX",o):i.set(e,t):"object"==typeof t&&Object.keys(t).forEach(o=>{i.hset(e,o,t[o],s.print)}))},getValue:function(e){return i.getAsync(e)},getHValue:e=>i.hgetallAsync(e),delValue:e=>{i.del(e,(e,t)=>{1===t?console.log("delete successfully"):console.log("delete redis key error:"+e)})}}},function(e,t,o){const s=o(11),n=o(0),i=o(7),{checkCode:a,getJWTPayload:r}=o(2),d=o(12),c=o(1),u=o(35),l=o(13),p=o(36);e.exports={getPostList:async function(e){const t=e.query,o=t.sort?t.sort:"created",n=t.page?parseInt(t.page):0,i=t.limit?parseInt(t.limit):20,a={};void 0!==t.catalog&&""!==t.catalog&&(a.catalog=t.catalog),void 0!==t.isTop&&(a.isTop=t.isTop),void 0!==t.status&&""!==t.status&&(a.isEnd=t.status),void 0!==t.tag&&""!==t.tag&&(a.tags={$elemMatch:{name:t.tag}});const r=await s.getList(a,o,n,i);console.log(r),e.body={code:200,data:r,msg:"获取文章列表成功"}},uploadImg:async function(e){const t=e.request.files.file;console.log("uploadImg -> file",t);const o=t.name.split(".").pop(),s=`${n.uploadPath}/${c().format("YYYYMMDD")}`;await u(s);const i=l(),a=`${s}/${i}.${o}`,r=p.createReadStream(t.path),d=p.createWriteStream(a),f=`/${c().format("YYYYMMDD")}/${i}.${o}`;r.pipe(d),e.body={code:200,msg:"图片上传成功",data:f}},addPost:async function(e){const{body:t}=e.request;console.log("addPost -> body",t);const o=t.sid,n=t.code;if(await a(o,n)){const o=await r(e.header.authorization),n=await i.findById({_id:o._id});if(console.log("addPost -> user",n),n.favs<t.fav)return void(e.body={code:501,msg:"积分不足"});await i.updateOne({_id:o._id},{$inc:{favs:-t.fav}});const a=new s(t);a.uid=o._id;const d=await a.save();e.body={code:200,msg:"成功保存的文章",date:d}}else e.body={code:500,msg:"图片验证码验证失败"}},updatePost:async function(e){const{body:t}=e.request,o=t.sid,n=t.code;if(await a(o,n)){const o=await r(e.header.authorization),n=await s.findById(t.tid);if(n.uid===o._id&&"0"===n.isEnd){const o=await s.updateOne({_id:n._id},t);e.body=o?{code:200,msg:"更新帖子成功"}:{code:500,msg:"更新帖子失败"}}else e.body={code:500,msg:"没有编辑帖子的权限"}}else e.body={code:500,msg:"图片验证码验证失败"}},getPostDetail:async function(e){const t=e.query;if(!t.tid)return void(e.body={code:500,msg:"文章id为空"});const o=await s.findByTid(t.tid);let n=0;if(void 0!==e.header.authorization&&""!==e.header.authorization){const o=await r(e.header.authorization),s=await d.findOne({uid:o._id,tid:t.tid});s&&s.tid&&(n=1)}const i=o.toJSON();i.isFav=n;const a=await s.updateOne({_id:t.tid},{$inc:{reads:1}});o._id&&1===a.ok?e.body={code:200,data:i,msg:"查询文章详情成功"}:e.body={code:500,msg:"获取文章详情失败"}},getPostListByUid:async function(e){const t=e.query,o=t.page?parseInt(t.page):0,n=t.limit?parseInt(t.limit):20,i=(await r(e.header.authorization))._id,a=await s.getListByUid(i,o,n),d=await s.countByUid(i);a.length>=0?e.body={code:200,data:a,nums:d,msg:"成功获取用户的文章列表"}:e.body={code:500,msg:"无法获取用户的文章"}},deletePostByUid:async function(e){const{body:t}=e.request,o=await r(e.header.authorization),n=await s.findById(t.tid);n.uid===o._id&&"0"===n.isEnd?(await s.deleteOne({_id:t.tid}),e.body={code:200,msg:"删除帖子成功"}):e.body={code:500,msg:"无法删除该帖子!"}}}},function(e,t,o){const s=o(4),n=o(1),i=new(0,s.Schema)({username:{type:String,index:{unique:!0},sparse:!0},name:{type:String},password:{type:String},created:{type:Date},updated:{type:Date},favs:{type:Number,default:100},gender:{type:String,default:""},roles:{type:Array,default:["user"]},pic:{type:String,default:"/img/bear-200-200.jpg"},mobile:{type:String,match:/^1[3-9](\d{9})$/,default:""},status:{type:String,default:"0"},regmark:{type:String,default:""},location:{type:String,default:""},isVip:{type:String,default:"0"},count:{type:Number,default:0}});i.pre("save",(function(e){this.created=n().format("YYYY-MM-DD HH-mm:ss"),e()})),i.pre("update",(function(e){this.updated=n().format("YYYY-MM-DD HH-mm:ss"),e()})),i.post("save",(function(e,t,o){"MogoError"===e.name&&11e3===e.code?o(new Error("Error:Mongoose has a duplicate key.")):o(e)})),i.statics={findByID:function(e){return this.findOne({_id:e},{password:0,username:0,mobile:0})}};const a=s.model("users",i);e.exports=a},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,o){const s=o(4),n=new(0,s.Schema)({tid:{type:String,ref:"post"},uid:{type:String,ref:"users"},cuid:{type:String,ref:"users"},content:{type:String},created:{type:Date},hands:{type:Number,default:0},status:{type:String,default:"1"},isRead:{type:String,default:"0"},isBest:{type:String,default:"0"}},{toJSON:{virtuals:!0}});n.pre("save",(function(e){this.created=new Date,e()})),n.post("save",(function(e,t,o){"MongoError"===e.name&&11e3===e.code?o(new Error("There was a duplicate key error")):o(e)})),n.statics={findByTid:function(e){return this.find({tid:e})},findByCid:function(e){return this.findOne({_id:e})},getCommentsList:function(e,t,o){return this.find({tid:e}).populate({path:"cuid",select:"_id name pic isVip",match:{status:{$eq:"0"}}}).populate({path:"tid",select:"_id title status"}).skip(t*o).limit(o)},queryCount:function(e){return this.find({tid:e}).countDocuments()},getCommetsPublic:function(e,t,o){return this.find({cuid:e}).populate({path:"tid",select:"_id title"}).skip(t*o).limit(o).sort({created:-1})},getMsgList:function(e,t,o){return this.find({uid:e,cuid:e,isRead:{$eq:"0"},status:{$eq:"1"}}).populate({path:"tid",select:"_id title"}).populate({path:"uid",select:"_id name"}).populate({path:"cuid",select:"_id name"}).skip(o*t).limit(o).sort({created:-1})},getTotal:function(e){return this.find({uid:e,isRead:"0",status:"1"}).countDocuments()}};const i=s.model("comments",n);e.exports=i},function(e,t){e.exports=require("path")},function(e,t,o){const s=o(4),n=o(1),i=new(0,s.Schema)({uid:{type:String,ref:"users"},title:{type:String},content:{type:String},created:{type:Date},catalog:{type:String},fav:{type:String,default:""},isEnd:{type:String,default:"0"},reads:{type:Number,default:0},answer:{type:Number,default:0},status:{type:String,default:"0"},isTop:{type:String,default:"0"},sort:{type:String,default:100},tags:{type:Array,default:[]}});i.virtual("user",{ref:"users",localField:"uid",foreignField:"_id"}),i.pre("save",(function(e){this.created=n().format("YYYY-MM-DD HH:mm:ss"),e()})),i.statics={getList:function(e,t,o,s){return this.find(e).sort({[t]:-1}).skip(o*s).limit(s).populate({path:"uid",select:"name isVip pic"})},getTopWeek:function(){return this.find({created:{$gte:n().subtract(7,"days")}},{answer:1,title:1}).sort({answer:-1}).limit(15)},findByTid:function(e){return this.findOne({_id:e}).populate({path:"uid",select:"name pic isVip _id"})},getListByUid:function(e,t,o){return this.find({uid:e}).skip(t*o).limit(o).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()}};const a=s.model("post",i);e.exports=a},function(e,t,o){const s=o(4),n=new(0,s.Schema)({uid:{type:String},tid:{type:String},title:{type:String},created:{type:Date}});n.pre("save",(function(e){this.created=new Date,e()})),n.post("save",(function(e,t,o){"MongoError"===e.name&&11e3===e.code?o(new Error("There was a duplicate key error")):o(e)})),n.statics={getListByUid:function(e,t,o){return this.find({uid:e}).skip(o*t).limit(o).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()}};const i=s.model("user_collect",n);e.exports=i},function(e,t){e.exports=require("uuid/v4")},function(e,t,o){const{checkCode:s,getJWTPayload:n}=o(2),i=o(9),a=o(11);e.exports={addComment:async function(e){const{body:t}=e.request;console.log("addComment -> body",t);const o=t.sid,r=t.code;if(await s(o,r)){const o=new i(t),s=await n(e.header.authorization);o.cuid=s._id;const r=await a.findOne({_id:t.tid});o.uid=r.uid;const d=await o.save(),c=await a.updateOne({_id:t.tid},{$inc:{answer:1}});d._id&&1===c.ok?e.body={code:200,msg:"成功发表评论",date:d}:e.body={code:500,msg:"评论失败"}}else e.body={code:500,msg:"图片验证码验证失败"}},getComments:async function(e){console.log("getComments");const t=e.query,o=t.tid;console.log("getComments -> tid",o);const s=t.page?t.page:0,n=t.limit?parseInt(t.limit):10;let a=await i.getCommentsList(o,s,n);console.log("getComments -> result",a);const r=await i.queryCount(o);console.log("getComments -> total",r),e.body={code:200,total:r,data:a,msg:"查询成功"}}}},function(e,t,o){const s=o(40),n=o(0),i=o(41);e.exports=async function(e){const t=s.createTransport({host:"smtp.163.com",port:465,secure:!0,auth:{user:"leedawnm@163.com",pass:"93thing51"}}),o=`${n.baseUrl}/#${"email"===e.type?"/confirm":"/reset"}?`+i.stringify(e.data);return`Message sent: %s, ${(await t.sendMail({from:'"认证邮件" <leedawnm@163.com>',to:e.email,subject:""!==e.user&&"email"!==e.type?`你好开发者，${e.user}！《慕课网前端全栈实践》注册码`:"论坛系统密码确认修改链接",text:`您在《慕课网前端全栈实践》课程中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n  \n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Imooc社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user}童鞋，重置链接有效时间30分钟，请在${e.expire}之前${e.code?"重置您的密码":"修改您的邮箱为："+e.data.username}：</div>\n          <a href="${o}" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">${e.code?"立即重置密码":"确认设置邮箱"}</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `})).messageId}`}},function(e,t){e.exports=require("bcrypt")},function(e,t,o){(function(e){const t=o(18),s=o(19),n=o(20),i=o(21),a=o(22),r=o(23),d=o(10),c=o(24),u=o(25),l=o(26),p=o(27),f=o(0),g=o(46),m=o(47),y=new t,h=new m;h.init(),global.ws=h;const w=a({secret:f.JWT_SECRET}).unless({path:[/^\/public/,/^\/login/,/^\/img/]}),b=l([c({multipart:!0,formidable:{keepExtensions:!0,maxFieldsSize:5242880},onError:e=>{console.log("koabody TCL:err",e)}}),n(d.join(e,"../public")),i(),u({pretty:!1,param:"pretty"}),s(),g,w]);y.use(r()),y.use(b),y.use(p()),y.listen(3e3)}).call(this,"src")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-jwt")},function(e,t){e.exports=require("koa-compress")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("koa-compose")},function(e,t,o){const s=o(28),n=o(29),i=o(37),a=o(42),r=o(44),d=o(45);e.exports=s(n,a,i,r,d)},function(e,t){e.exports=require("koa-combine-routers")},function(e,t,o){const s=o(3),n=o(30),i=o(6),a=o(14),r=new s;r.prefix("/public"),r.get("/getCaptcha",n),r.get("/list",i.getPostList),r.get("/comments",a.getComments),e.exports=r},function(e,t,o){const s=o(31),n=o(5);e.exports=function(e){const t=e.request.query;console.log(t.sid);const o=s.create({size:4,ignoreChars:"0olil",color:!0,noise:Math.floor(5*Math.random()),width:150,height:50});n.setValue(t.sid,o.text,600),e.body={code:200,data:o.data}}},function(e,t){e.exports=require("svg-captcha")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("make-dir")},function(e,t){e.exports=require("fs")},function(e,t,o){const s=o(3),{userSign:n,updateUserInfo:i,changePassword:a,getMsg:r,setMsg:d,addCollect:c,getCollectByUid:u}=o(38),{getPostListByUid:l,deletePostByUid:p}=o(6),f=new s;f.prefix("/user"),f.get("/fav",n),f.post("/basic",i),f.post("/changePassword",a),f.get("/getMsg",r),f.get("/setMsg",d),f.get("/post",l),f.post("/deletePost",p),f.post("/setCollect",c),f.get("/collect",u),e.exports=f},function(e,t,o){const s=o(39),n=o(7),i=o(2),{setValue:a}=o(5),{send:r}=o(15),d=o(0),{getJWTPayload:c}=o(2),u=o(9),l=o(12),p=o(1),f=o(13),g=o(8),m=o(16);e.exports={userSign:async function(e){const t=await i.getJWTPayload(e.header.authorization),o=await s.findByUid(t._id);console.log("userSign -> record",o);const a=await n.findByID(t._id);let r={},d="";if(o.created="2020-03-14T02:54:41.000Z",null!==o){if(p(o.created).format("YYYY-MM-DD")===p().format("YYYY-MM-DD"))return void(e.body={code:500,favs:a.favs,count:a.count,lastSign:o.created,msg:"用户已经签到"});{let e=a.count;console.log("userSign -> count",e);let i=0;p(o.created).format("YYYY-MM-DD")===p().subtract(1,"days").format("YYYY-MM-DD")?(e+=1,e<5?i=5:e>=5&&e<15?i=10:e>=15&&e<30?i=15:e>=30&&e<100?i=20:e>=100&&e<365?i=30:e>=365&&(i=50),await n.updateOne({_id:t._id},{$inc:{favs:i,count:1}}),d={favs:a.favs+i,count:a.count+1}):(i=5,await n.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:i}}),d={favs:a.favs+i,count:1}),r=new s({uid:t._id,favs:i}),await r.save()}}else await n.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),r=new s({uid:t._id,favs:5}),await r.save(),d={favs:a.favs+5,count:1};e.body={code:200,msg:"请求成功",...d,lastSign:r.created}},updateUserInfo:async function(e){const{body:t}=e.request;console.log("updateUserInfo -> body",t);const o=await i.getJWTPayload(e.header.authorization);console.log("updateUserInfo -> obj",o);const s=await n.findOne({_id:o._id});console.log("updateUserInfo -> user",s);let c="";if(t.username&&t.username!==s.username){const i=await n.findOne({username:t.username});if(console.log("updateUserInfo -> tmpUser",i),i&&i.password)return void(e.body={code:501,msg:"邮箱已经注册"});const u=f();a(u,g.sign({_id:o._id},d.JWT_SECRET,{expiresIn:"30m"})),await r({type:"email",data:{key:u,username:t.username},code:"",expire:p().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:s.username,user:s.name}),c="更新基本资料成功，账号修改需要邮件确认，请查收邮件"}["username","mobile","password"].map(e=>{delete t[e]});const u=await n.updateOne({_id:o._id},t);console.log("result",u),1===u.n&&1===u.ok?e.body={code:200,msg:""===c?"更新成功":c}:e.body={code:500,msg:"更新失败"}},changePassword:async function(e){const{body:t}=e.request;console.log("changePassword -> body",t);const o=await i.getJWTPayload(e.header.authorization),s=await n.findOne({_id:o._id});if(console.log("changePassword -> user",s),await m.compare(t.oldPassword,s.password)){t.newPassword=await m.hash(t.newPassword,5),console.log("changePassword ->  body.newPassword",t.newPassword);const s=await n.updateOne({_id:o._id},{password:t.newPassword});console.log("result",s),1===s.n&&1===s.ok?e.body={code:200,msg:"更新成功"}:e.body={code:500,msg:"更新失败"}}else e.body={code:501,msg:"原来的密码填写错误"}},getMsg:async function(e){const t=e.query,o=t.page?t.page:0,s=t.limit?parseInt(t.limit):0,n=await c(e.header.authorization),i=await u.getMsgList(n._id,o,s),a=await u.getTotal(n._id);console.log("getMsg -> result",i),e.body={code:200,data:i,total:a}},setMsg:async function(e){const t=e.query;if(t.id){1===(await u.updateOne({_id:t.id},{isRead:"1"})).ok&&(e.body={code:200})}else{const t=await c(e.header.authorization);1===(await u.updateMany({uid:t._id},{isRead:"1"})).ok&&(e.body={code:200})}},addCollect:async function(e){const{body:t}=e.request,o=await c(e.header.authorization);if(t.isFav)await l.deleteOne({uid:o._id,tid:t.tid}),e.body={code:200,msg:"帖子已经取消收藏！"};else{const s=new l({uid:o._id,tid:t.tid,title:t.title});(await s.save()).uid&&(e.body={code:200,msg:"帖子收藏成功！"})}},getCollectByUid:async function(e){const t=e.query,o=await c(e.header.authorization),s=o._id,n=parseInt(t.page),i=parseInt(t.limit),a=await l.getListByUid(s,n,i),r=await l.countByUid(o._id);a.length>0?e.body={code:200,data:a,nums:r,msg:"查询收藏的帖子成功"}:e.body={code:500,msg:"查询失败"}}}},function(e,t,o){const s=o(4),n=o(1),i=new(0,s.Schema)({uid:{type:String,ref:"users"},created:{type:Date},favs:{type:Number},lastSign:{type:Date}});i.pre("save",(function(e){this.created=n().format("YYYY-MM-DD HH:mm:ss"),e()})),i.statics={findByUid:function(e){return this.findOne({uid:e}).sort({created:-1})}};const a=s.model("sign_record",i);e.exports=a},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("qs")},function(e,t,o){const s=o(3),n=o(43),i=new s;i.prefix("/login"),i.post("/login",n.login),i.post("/reg",n.reg),i.post("/forget",n.forget),i.post("/reset",n.reset),e.exports=i},function(e,t,o){const s=o(15),n=o(16),i=o(1),a=o(8),r=o(0),d=o(2),c=o(7);e.exports={forget:function(e){const{body:t}=e.request;if(void 0!==t.username)try{let o=s({code:"1234",expire:i().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:"echo"});e.body={code:200,data:o,msg:"邮件发送成功"}}catch(e){console.log(e)}else e.body={code:500,msg:"服务器异常"}},login:async function(e){const{body:t}=e.request;let o=t.sid,s=t.code,i=await d.checkCode(o,s);if(console.log(i),i){let o=!1,s=await c.findOne({username:t.username});if(await n.compare(t.password,s.password)&&(o=!0),o){const t=s.toJSON();["password"].map(e=>{delete t[e]});let o=a.sign({_id:t._id},r.JWT_SECRET,{expiresIn:"1d"});e.body={code:200,data:t,token:o}}else e.body={code:404,msg:"用户名或密码错误"}}else e.body={code:401,msg:"图片验证码不正确，请检查！"}},reg:async function(e){const{body:t}=e.request;console.log("reg -> body",t);let o=t.sid,s=t.code,a={},r=await d.checkCode(o,s);console.log("result:"+r);let u=!0;if(r){let o=await c.findOne({username:t.username});null!==o&&void 0!==o.username&&(console.log("user1"+o),a.username=["此邮箱已经被注册，可以通过邮箱找回密码"],u=!1),u=!0;let s=await c.findOne({name:t.name});if(null!==s&&void 0!==s.name&&(a.name=["此昵称已经被注册，请修改"],u=!1),u){t.password=await n.hash(t.password,5);let o=new c({username:t.username,name:t.name,password:t.password,created:i().format("YYYY-MM-DD HH:mm:ss")}),s=await o.save();return void(e.body={code:200,data:s,msg:"注册成功"})}}else a.code=["验证码已经失效，请重新获取！"];e.body={code:500,msg:a}},reset:async function(e){const{body:t}=e.request;console.log("reset -> body",t,t.username);let o=t.sid,s=t.code,u={};if(await d.checkCode(o,s)){let o=await c.findOne({username:t.username});if(null===o&&"undefined"===o.username)u.username=["此邮箱未注册，请确认"],e.body={code:500,msg:u};else{o.password=await n.hash(t.password,5),o.updated=i().format("YYYY-MM-DD HH:mm:ss");const s=(await o.save()).toJSON();["password"].map(e=>{delete s[e]});let d=a.sign({_id:s._id},r.JWT_SECRET,{expiresIn:"1d"});e.body={code:200,data:s,token:d,msg:"更新密码成功！"}}}else e.body={code:401,msg:"图片验证码不正确，请检查！"}}}},function(e,t,o){const s=o(3),n=o(6),i=new s;i.prefix("/content"),i.post("/upload",n.uploadImg),i.post("/add",n.addPost),i.post("/update",n.updatePost),i.get("/detail",n.getPostDetail),e.exports=i},function(e,t,o){const s=o(3),{addComment:n}=o(14),i=new s;i.prefix("/comments"),i.post("/reply",n),e.exports=i},function(e,t,o){e.exports=(e,t)=>t().catch(t=>{401==t.status?(e.status=401,e.body={code:401,msg:"Protected resource,use Authorization header to get access\n"}):(e.status=t.status||500,e.body=Object.assign({code:500,msg:t.message},{}))})},function(e,t,o){const s=o(48),{getJWTPayload:n}=o(2),i=o(9),a=o(0);e.exports=class{constructor(e={}){const t={...{port:a.wsPort,timeInterval:5e3,isAuth:!0},...e};this.wss={},this.timeInterval=t.timeInterval,this.isAuth=t.isAuth,this.port=t.port,this.options=e.options||{}}init(){this.wss=new s.Server({port:this.port,...this.options}),this.wss.on("connection",e=>{e.isAlive=!0,e.send(JSON.stringify({event:"heartbeat",message:"ping"})),e.on("message",t=>this.onMessage(e,t)),e.on("close",()=>this.onClose(e))}),this.heartbeat()}onMessage(e,t){const o=JSON.parse(t);({auth:async()=>{try{const t=await n(o.message);if(t){e.isAuth=!0,e._id=t._id;const o=await i.getTotal(t._id);e.send(JSON.stringify({event:"message",message:o}))}}catch(t){e.send(JSON.stringify({event:"noauth",message:"please auth again"}))}},heartbeat:()=>{"pong"===o.message&&(e.isAlive=!0)},message:()=>{}})[o.event]()}send(e,t){this.wss.clients.forEach(o=>{o.readyState===s.OPEN&&o._id===e&&o.send(t)})}broadcast(e){this.wss.clients.forEach(t=>{t.readyState===s.OPEN&&t.send(e)})}onClose(){}heartbeat(){clearInterval(this.interval),this.interval=setInterval(()=>{this.wss.clients.forEach(e=>{if(!e.isAlive)return e.terminate();e.isAlive=!1,e.send(JSON.stringify({event:"heartbeat",message:"ping"}))})},this.timeInterval)}}},function(e,t){e.exports=require("ws")}]);